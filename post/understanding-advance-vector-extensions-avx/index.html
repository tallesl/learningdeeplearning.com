<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Notes on learning deep learning and everything LLM-related">
    <title>Understanding Advance Vector Extensions (AVX) | Learning Deep Learning</title>
    <link rel="icon" href="/favicon.png" type="image/png">
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <style>
  body {
    background-image: radial-gradient(#8e8 1.2px, #eee 1.2px);
    background-size: 12px 12px;
  }

  main img {
    display: block;
    margin: 0 auto;
  }
</style>

  </head>

  <header style="text-align: center;">
    
      <a href="https://learningdeeplearning.com/">
        <img src="https://learningdeeplearning.com/images/logo.png" alt="Logo" style="max-width: 200px; height: auto; margin: 0 auto; display: block;">
      </a>
    
  </header>

  <body>
    <nav>
    <ul class="menu">
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">Understanding Advance Vector Extensions (AVX)</span></h1>

<p class="date">Jun 15, 2024</p>
</div>

<main>
<p>I’ve been playing LLMs locally and an acronym that is a usual suspect on documentation pages is &ldquo;AVX&rdquo;.</p>
<p><img src="/images/understanding-advance-vector-extensions-avx/ctranslate2-readme.png" alt=""></p>
<p><img src="/images/understanding-advance-vector-extensions-avx/llama-cpp-readme.png" alt=""></p>
<p><strong>Advanced Vector Extensions</strong> is a SIMD extension to x86 architecture. Well, that’s what
<a href="https://en.wikipedia.org/wiki/Advanced_Vector_Extensions">Wikipedia</a> says anyway.</p>
<p>Let’s get into this rabbit hole and figure out how AVX relates to LLMs.</p>
<h2 id="single-instruction-multiple-data-simd">Single Instruction, Multiple Data (SIMD)</h2>
<p><strong>“Single Instruction, Multiple Data”</strong> is one of the best self-explanatory acronyms I’ve seen in a while! It&rsquo;s pretty
much what it says, performing a single instruction with a big set of registers:</p>
<p><img src="/images/understanding-advance-vector-extensions-avx/simd.png" alt=""></p>
<p>On the left side of the picture (orange boxes), we can see two scalar values being summed. On the right side
(multi-colored boxes), due to SIMD, we can see two entire vectors of values being summed in “one shot” (in parallel).</p>
<p>Take a look at this handy diagram with the current registers of x86, and let’s focus on XMM, YMM, and ZMM registers
(highlighted by me):</p>
<p><img src="/images/understanding-advance-vector-extensions-avx/zmm-registers.png" alt=""></p>
<p>The XMM registers are 128-bit, which is the original AVX. AVX2 introduced YMM registers, which overlap with the XMM
giving us 256-bit long registers. The latest AVX version, AVX-512, has increased yet again, to 512-bit now (ZMM
registers).</p>
<h2 id="show-me-the-code">Show Me the Code</h2>
<p>Here is an example of summing vectors using <a href="https://gcc.gnu.org/onlinedocs/gcc-4.1.2/gcc/Vector-Extensions.html">GCC Vector Extensions</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#define LENGTH 4
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">int</span> v4si <span style="color:#a6e22e">__attribute__</span> ((vector_size (LENGTH <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>))));

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">print_vector</span>(<span style="color:#66d9ef">const</span> v4si<span style="color:#f92672">*</span> vector) {
    printf(<span style="color:#e6db74">&#34;{ &#34;</span>);
    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> LENGTH; <span style="color:#f92672">++</span>i) printf(<span style="color:#e6db74">&#34;%d &#34;</span>, (<span style="color:#f92672">*</span>vector)[i]);
    printf(<span style="color:#e6db74">&#34;}&#34;</span>);
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    v4si a <span style="color:#f92672">=</span> {<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>};
    v4si b <span style="color:#f92672">=</span> {<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">8</span>};
    v4si c <span style="color:#f92672">=</span> a <span style="color:#f92672">+</span> b;

    print_vector(<span style="color:#f92672">&amp;</span>a);
    printf(<span style="color:#e6db74">&#34; + &#34;</span>);
    print_vector(<span style="color:#f92672">&amp;</span>b);
    printf(<span style="color:#e6db74">&#34; = &#34;</span>);
    print_vector(<span style="color:#f92672">&amp;</span>c);
    printf(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>Compiling it and executing it:</p>
<pre tabindex="0"><code>$ gcc -o vector_sum vector_sum.c 

$ ./vector_sum 

{ 1 2 3 4 } + { 5 6 7 8 } = { 6 8 10 12 }
</code></pre><p>A silly benchmark:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;time.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#define LENGTH 4
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">int</span> v4si <span style="color:#a6e22e">__attribute__</span> ((vector_size (LENGTH <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>))));

<span style="color:#75715e">// Summing two scalar values per iteration
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">regular_sum</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>a, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>b, <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>c) {
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> LENGTH; <span style="color:#f92672">++</span>i) {
        c[i] <span style="color:#f92672">=</span> a[i] <span style="color:#f92672">+</span> b[i];
    }
}

<span style="color:#75715e">// Summing two vectors at once (no iteration)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">vector_extensions_sum</span>(<span style="color:#66d9ef">const</span> v4si <span style="color:#f92672">*</span>a, <span style="color:#66d9ef">const</span> v4si <span style="color:#f92672">*</span>b, v4si <span style="color:#f92672">*</span>result) {
    <span style="color:#f92672">*</span>result <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>a <span style="color:#f92672">+</span> <span style="color:#f92672">*</span>b;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">benchmark</span>(<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>func)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>), <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>a, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>b) {
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">int</span> ITERATIONS <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000000000</span>; <span style="color:#75715e">// one billion
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">union</span> { <span style="color:#66d9ef">int</span> int_c[LENGTH]; v4si vec_c; } throwaway_result;

    clock_t start <span style="color:#f92672">=</span> clock(); <span style="color:#75715e">// getting start time
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> ITERATIONS; <span style="color:#f92672">++</span>i) func(a, b, <span style="color:#f92672">&amp;</span>throwaway_result); <span style="color:#75715e">// iterating a billion times
</span><span style="color:#75715e"></span>    clock_t end <span style="color:#f92672">=</span> clock(); <span style="color:#75715e">// getting end time
</span><span style="color:#75715e"></span>
    printf(<span style="color:#e6db74">&#34;%f seconds</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ((<span style="color:#66d9ef">double</span>)(end <span style="color:#f92672">-</span> start)) <span style="color:#f92672">/</span> CLOCKS_PER_SEC);
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#66d9ef">int</span> a[LENGTH] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>};
    <span style="color:#66d9ef">int</span> b[LENGTH] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">8</span>};
    
    v4si va <span style="color:#f92672">=</span> {<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>};
    v4si vb <span style="color:#f92672">=</span> {<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">8</span>};

    printf(<span style="color:#e6db74">&#34;Regular sum: &#34;</span>);
    benchmark((<span style="color:#66d9ef">void</span>(<span style="color:#f92672">*</span>)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>))regular_sum, a, b);

    printf(<span style="color:#e6db74">&#34;Vector extensions sum: &#34;</span>);
    benchmark((<span style="color:#66d9ef">void</span>(<span style="color:#f92672">*</span>)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>))vector_extensions_sum, <span style="color:#f92672">&amp;</span>va, <span style="color:#f92672">&amp;</span>vb);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>Here&rsquo;s the numbers from my Ryzen 5 4600H:</p>
<pre tabindex="0"><code>$ gcc -o silly_benchmark silly_benchmark.c 

$ ./silly_benchmark

Regular sum: 17.339803 seconds
Vector extensions sum: 2.371874 seconds
</code></pre><h2 id="what-about-llms">What About LLMs?</h2>
<p>Since an LLM is just a bunch of neatly organized vectors, linear algebra (the study of vectors and linear functions) is
essential for anything performed on it. Going further into this topic is beyond the scope of this article (and of my
knowledge), but you can already imagine how we can save precious CPU cycles by doing calculations with vectors in “one
shot” using AVX instructions.</p>
<p>But there’s only so much you can squeeze out from extending a processor architecture
<a href="https://en.wikipedia.org/wiki/Intel_8086">dating back to 1978</a>. ‘Serious people’ use NVIDIA’s CUDA, AMD’s ROCm, or
Intel’s oneAPI, but that’s another post for another day.</p>

</main>

    <hr>
    <footer>
      <p>
        <a href="mailto:talleslasmar@gmail.com">📧</a>
        | 
        <a href="https://github.com/tallesl"><img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub" style="height: 25px; vertical-align: middle;"></a>
        |
        <a href="https://creativecommons.org/publicdomain/zero/1.0/"><img src="https://licensebuttons.net/p/zero/1.0/88x31.png" alt="CC0" style="height: 20px; vertical-align: middle;"></a>
      </p>
    </footer>
  </body>
</html>

